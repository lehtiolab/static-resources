external_config_version = 'main'

includeConfig "https://raw.githubusercontent.com/lehtiolab/static-resources/${external_config_version}/nf-configs/pdc_dardel.config"

def listify(it) {
  /* This function is useful when needing a list even when having a single item
  - Single items in channels get unpacked from a list
  - Processes expect lists. Even though it would be fine
  without a list, for single-item-lists any special characters are not escaped by NF
  in the script, which leads to errors. See:
  https://github.com/nextflow-io/nextflow/discussions/4240
  */
  return it instanceof java.util.List ? it : [it]
}



params {
  // 20 nodes from shared partition and 4 from memory partition
  nodelist = 'nid001071,nid001072,nid001073,nid001074,nid001075,nid002568,nid002569,nid002570,nid002571,nid002572,nid002573,nid002574,nid002575,nid002576,nid002577,nid002578,nid002579,nid002580,nid002581,nid002582,nid002554,nid002555,nid002556,nid002557'

  clusterOptions = "-N 1 --nodelist=${params.nodelist}"
  cachedir = '/cfs/klemming/projects/supr/snic2019-35-26/kantele_runs/nf_workdir/__spectronaut_cache'
}

// Always overbook half a node with cpus=130,
// so we cannot run multiple processes on a single node.
// This is done because that is incompatible with license, program will crash
process {
  withName: generateLibrary {
    cpus = 130
    memory = {listify(raws).size() > 10 ? 128.GB + 2.GB * raws.size() * task.attempt : 128.GB }
    time = {listify(raws).size() > 4 ? 0.25.h * raws.size() * task.attempt : 2.h}
  }

  withName: mergePsar {
    cpus = 130
    memory = 230.GB
  }

  withName: searchDIA {
    cpus = 130
    memory = {listify(raws).size() > 10 ? 128.GB + 2.GB * raws.size() * task.attempt : 128.GB }
    time = {listify(raws).size() > 4 ? 0.25.h * raws.size() * task.attempt : 2.h}
  }

  withName: mergeSNE {
    cpus = 130
    memory = 230.GB
  }

  withName: quantReport {
    cpus = 130
    memory = 230.GB
  }
}
