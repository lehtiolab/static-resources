external_config_version = 'main'

includeConfig "https://raw.githubusercontent.com/lehtiolab/static-resources/${external_config_version}/nf-configs/lehtio.config"


trace {
  file = './trace.txt'
  overwrite = true
}
params {
  // Set DB, DIA lib
  // data_file_path is in the lehtio.conf file
  db = "${data_file_path}/Uniprot_2024_06_Homo_sapiens_Swiss_canonical_isoforms.fa"
  library = "${data_file_path}/libfile_212_uniprot_swiss_2025_01_Homo_sapiens_diaNN_1.9.2_oxcarba_2mods.parquet"
}

process {
  clusterOptions = '--qos=qc'

  withName: DiaNN {
    time = 4.h
    memory = 64.GB
  }

  withName: percolator {
    time = { listify(mzids).size() > 40 ? 0.1.h * listify(mzids).size() * task.attempt : 4.h * task.attempt }
    cpus = 4
  }

  withName: createPSMTable {
    // lookup size is a proxy for amount of PSMs
    time = { (lookup.size() >> 30) > 1 ? 1.h * (lookup.size() >> 30) * task.attempt : 2.h * task.attempt }
    // protein grouping needs memory if there's lots of information
    memory = { (lookup.size() >> 30) < 40 ? task.attempt * 16.GB : "${(task.attempt * lookup.size() * 0.4).round()}B"}
    scratch = true
  }
}
